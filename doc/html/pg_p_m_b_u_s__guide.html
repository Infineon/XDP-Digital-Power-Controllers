<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>XDPP1100 Firmware: PMBUS User Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_infineon.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">XDPP1100 Firmware
   </div>
   <div id="projectbrief">The firmware documentation for the XDPP1100 device family.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pg_p_m_b_u_s__guide.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">PMBUS User Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sctIntro"></a>
Some Key Features Of PMBus</h1>
<p>-A PMBus device is a 3-wire interface used as a communication channel between a master and a slave. There is a Clock, a Data and an Alert Line.</p>
<p>-Multiple telemetry registers monitor the state of the chip.</p>
<p>-ALERT line can quickly notify the user of problems.</p>
<p>-Status registers can help diagnose problems and faults.</p>
<p>-Linear Format allows for extremely fine resolution in voltage steps.</p>
<p>-Packet Error Checking for error detection</p>
<h1><a class="anchor" id="sctIntro1"></a>
PMBus Characteristics</h1>
<table class="doxtable">
<tr>
<th>Feature </th><th>ROM code supported  </th></tr>
<tr>
<td>Bus Speed </td><td>Upto 1Mhz </td></tr>
<tr>
<td>Timeout </td><td>30ms </td></tr>
<tr>
<td>Packet Error Checking </td><td>yes </td></tr>
<tr>
<td>General Call Address (0x0) </td><td>no </td></tr>
<tr>
<td>SMBALERT# </td><td>yes </td></tr>
<tr>
<td>Read/Write Byte </td><td>yes </td></tr>
<tr>
<td>Read/Write Word </td><td>yes </td></tr>
<tr>
<td>Read/Write Block </td><td>yes </td></tr>
<tr>
<td>MFR Command Support </td><td>yes </td></tr>
<tr>
<td>Group Command </td><td>no </td></tr>
<tr>
<td>Zone Command </td><td>no </td></tr>
</table>
<h1><a class="anchor" id="sctAlert"></a>
SMBALERT#</h1>
<p>The ALERT# line is used to notify the Master when a fault has occurred. These include:</p>
<p>-Corrupted, invalid, or unsupported data</p>
<p>-Sending or receiving too few / too many bits.</p>
<p>-Sending or receiving too few / too many bytes.</p>
<p>-Improperly set read bit</p>
<p>-Unsupported command code</p>
<p>-Over temperature fault</p>
<p>-CPU is busy servicing higher priority faults.</p>
<p>The ALERT# line is cleared with the command CLEAR_FAULTS, toggling enable pin, or by sending an Alert Response Address. For more information, see PMBus Specification Part 2, section 10.8</p>
<p>The Alert Response Address (ARA) is a special address that causes all devices with an ALERT# to respond with their device address. A lower address device has higher priority than a higher address device (0x7E will win over 0xEE). After receiving the ACK, the device clears its ALERT#. For more information, see SMBus Specification v2.0, pg.55.</p>
<div class="image">
<img src="ara.png" alt="ara.png"/>
<div class="caption">
Alert Response Address (ARA)</div></div>
<h1><a class="anchor" id="sctDecode"></a>
How to Decode Waveforms</h1>
<div class="image">
<img src="example_pmbus_xfer.png" alt="example_pmbus_xfer.png"/>
<div class="caption">
Example PMBus Transfer</div></div>
<ol type="1">
<li>Know the system</li>
</ol>
<p>-How many loops?</p>
<p>-Which addresses?</p>
<p>-If you don’t know the address, you can always “scan” the bus by addressing every address and seeing which ones respond.</p>
<ol type="1">
<li>Check the Address</li>
</ol>
<p>-Does it correspond to a known address? Which device?</p>
<p>-You should expect the rest of the transaction to conform to a PMBus Format.</p>
<ol type="1">
<li>Check the rest of the data</li>
</ol>
<p>-Based on knowledge of the expected format, interpret the rest of the transaction.</p>
<p>-Refer to PMBus Specification Part 2 for details on specific command structure (type of command, number of bytes, etc).</p>
<p>-All errors in PMBus structure have a corresponding fault. The fault conditions and responses can be seen in section 10.8.</p>
<p>-Check STATUS_WORD and STATUS_CML if you suspect a communication fault.</p>
<div class="image">
<img src="howto_read_pmbus_xfer.png" alt="howto_read_pmbus_xfer.png"/>
<div class="caption">
How To Read a PMBus Transfer</div></div>
 <div class="image">
<img src="example_pmbus_xfer_scope.png" alt="example_pmbus_xfer_scope.png"/>
<div class="caption">
Scope View of a PMBus Transfer</div></div>
 <div class="image">
<img src="matchup.png" alt="matchup.png"/>
<div class="caption">
Matchup to Spec</div></div>
 <div class="image">
<img src="decode.png" alt="decode.png"/>
<div class="caption">
Decoding The Bus</div></div>
<ol type="1">
<li>Data goes low when the clock is high, this is the start symbol that tells the clock to start clocking data</li>
</ol>
<p>2–3. The sections labeled 2 and 3 are transmitted together as one byte from the master and received by the slave. The first 7 bits determines the slave address and the 8th bit determines whether a read or write function is to be performed. In this case the function is “write” indicated by a 0.</p>
<ol type="1">
<li>This one bit, called the Acknowledge, is transmitted by the slave and received by the master that tells the master that the slave received its previous transmission.</li>
<li>The Master Transmits a byte of data back to the slave.</li>
<li>The slave once again Acknowledges that the data has been received.</li>
<li>While the clock is high our data rises to high, this is the stop symbol that tells the clock no more data is being sent and the clock goes quiet(remains at logic 1).</li>
</ol>
<h1><a class="anchor" id="sctPMBUS_CMDS"></a>
PMBus Command Set Descriptions</h1>
<p><a href="../regmap/pmbus.html">Pmbus Command Descriptions</a></p>
<h1><a class="anchor" id="sctAddcmds"></a>
Adding PMBus MFR Commands To Example Project</h1>
<p>Provided in the patch_user_app project is a spreadsheet called shasta_pmbus.xlsx. It is used for autogeneration of pmbus command structures to add new mfr specific commands.</p>
<p>To add an example command open the spreadsheet with an excel editor. </p><div class="image">
<img src="shasta_pmbus_spreadsheet.png" alt="shasta_pmbus_spreadsheet.png"/>
<div class="caption">
Spreadsheet View When Opened</div></div>
 Next we want to name our new command. In this example we name it MFR_USER_COMMAND_EXAMPLE. Make sure to check with pmbus spec that location is not reserved and is allow to be an MFR_SPECIFIC type command.</p>
<div class="image">
<img src="addcmd1.png" alt="addcmd1.png"/>
<div class="caption">
Adding name for new PMBus command</div></div>
 Now we want to choose the correct protocol and number of bytes. Choose the write protocol by right clicking on the Wr Tx cell and select pick from drop down this will give you a choice on supported write protocols. Note that if command is read only leave this cell blank.</p>
<p>Then select rd tx cell and choose the manner for the read protocol where write only commmands would leave this cell blank.</p>
<p>Then enter the number of bytes the command has for data (not including protocol bytes like command code).</p>
<p>Select 'y' in MFR cell to put tell the autogen to place in the patch_user_app area.</p>
<div class="image">
<img src="addcmd2.png" alt="addcmd2.png"/>
<div class="caption">
Adding Protocol Attributes</div></div>
 Now enter the OTP storage attributes. First select loop support. Note that this must be y on both loops to support the command.</p>
<p>Then select a range. If you leave the cell blank there is no range check for the command (which is the most common and lowest latency to command execution time). If you select unsigned signified by a 'u' prefix like u8.0 the range check will ensure the data is unsigned. Note that providing a number less than the command size will not exclude the unused bits but does provide the API a way to do it. Please contact your local FAE for advanced range checking support if required.</p>
<p>Then enter the Loop 0 OTP nBits cell as the number of bits to store. Note this must be a direct multiplier of the byte count. Partial masking is not supported.</p>
<p>Next create a mask in the Loop0 OTP Store column, which also has to match the number of bytes as partial masking is not supported.</p>
<p>Copy Loop0 cells G-K to Loop1 cells L-P as command size differences per loop are not supported.</p>
<div class="image">
<img src="addcmd4.png" alt="addcmd4.png"/>
<div class="caption">
Adding OTP Storage Attributes</div></div>
 For functional commands if you plan to execute a function as a callback or handle from the bus transfer select Y in the HAS FW HANDLE. Note that if you want multiple commands to share the same function callback set the HAS_FW_HANDLE = the B column command name and if that has a 'y' in its HAS_FW_HANDLE cell it will set the callback to it. For example the command STATUS_BYTE is assigned to the same callback as STATUS_WORD so the HAS_FW_HANDLE column = STATUS_WORD.</p>
<p>Enter a 'n' in common storage if the command has separate data storage per loop or a 'y' if both loops point to the same data for that command.</p>
<div class="image">
<img src="addcmd3.png" alt="addcmd3.png"/>
<div class="caption">
Adding Firmware Callback Functions and Loop Storage</div></div>
 Now lets build our new code for pmbus command from eclipse it looks like this or 'make pmbus' command line target</p>
<div class="image">
<img src="make_pmbus.png" alt="make_pmbus.png"/>
<div class="caption">
Make pmbus target</div></div>
 The output of the MFR command added to <a class="el" href="pmbus__mfr__autogen_8c.html">pmbus_mfr_autogen.c</a> and <a class="el" href="pmbus__mfr__autogen_8h.html">pmbus_mfr_autogen.h</a> and will look like this FAN_CONFIG_1_2 example command. The comments should match your spreadsheet entries for protocol. The command structure is ultimately compressed into CMD_CONFIG variable. All structure is stored in RAM so it can be changed at runtime for patch testing.</p>
<div class="image">
<img src="fan_config_1_2_example_mfr_command.png" alt="fan_config_1_2_example_mfr_command.png"/>
<div class="caption">
Example of MFR Command Output</div></div>
 If you selected HAS_FW_HANDLE = 'y' then you will get an extern of the function prototype. Next its up to the user to implement the command handle to add functionality when implementing the command. The extern user function prototypes will show up in <a class="el" href="pmbus__mfr__autogen_8h.html">pmbus_mfr_autogen.h</a></p>
<div class="image">
<img src="handle_output.png" alt="handle_output.png"/>
<div class="caption">
Example of Handle Output</div></div>
 In this example <a class="el" href="pmbus__mfr__specific__handlers_8c.html#aa5f8ccd4e0f3371ace4955b2649258f2">PMBUS_HANDLE_FAN_CONFIG_1_2</a> is found in <a class="el" href="pmbus__mfr__specific__handlers_8c.html">pmbus_mfr_specific_handlers.c</a> we want to execute the same functionality when we get a write on PMBus of this command or when we restore from OTP. This is done by using an if statement on the direction argument and comparing against <a class="el" href="pmbus__autogen_8h.html#a5b83f682def4f4d00b47d1d93bd28dad">PMBUS_DIRECTION_e</a> types.</p>
<div class="image">
<img src="fan_config_1_2_example_mfr_command_handle.png" alt="fan_config_1_2_example_mfr_command_handle.png"/>
<div class="caption">
Example of Implementing a Command Handle</div></div>
<h1><a class="anchor" id="sctXADDR"></a>
XADDR Pin Offsets</h1>
<p>The PMBus and I2C addresses can be modified to allow multiple parts in the same system with same PMBUS configuration. By selecting the address offset enable the base address from the pmbus command is offset by the following xaddr pin resistor values:</p>
<table class="doxtable">
<tr>
<th>XADDR Resistor </th><th>Decoded ADDRESS Offset From Base Defined in PMBUS Command  </th></tr>
<tr>
<td>47k </td><td>0 </td></tr>
<tr>
<td>18k </td><td>1 </td></tr>
<tr>
<td>10k </td><td>2 </td></tr>
<tr>
<td>6.8k </td><td>3 </td></tr>
<tr>
<td>3.9k </td><td>4 </td></tr>
<tr>
<td>2.7k </td><td>5 </td></tr>
<tr>
<td>1.8k </td><td>6 </td></tr>
<tr>
<td>1.2k </td><td>7 </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Nov 8 2023 10:17:00 for XDPP1100 Firmware by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
