<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>XDPP1100 Firmware: __main.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_infineon.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">XDPP1100 Firmware
   </div>
   <div id="projectbrief">The firmware documentation for the XDPP1100 device family.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('____main_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">__main.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Contains the initialisation of all software parts. It is assumed that the hardware part is already initialised when calling functions within this file. The essential part of this file is the definition of an own __main symbol to suppress the linking of tool specific libraries which create a bare metal C environment. This allows full control over the executable image but one has to consider that the RAM initialisation including decompression (if not deactivated) and other desired functionality like floating point support must be re-implemented.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="fw__config_8h.html">fw_config.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="patch__run_8h.html">patch_run.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="environment_8h.html">environment.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="linker__sections_8h.html">linker_sections.h</a>&quot;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &quot;<a class="el" href="system__shasta_8h.html">system_shasta.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="cmsis__os__ext_8h.html">cmsis_os_ext.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sys__boot__descr__format_8h.html">sys_boot_descr_format.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="shasta__hal__cgu_8h.html">shasta_hal_cgu.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="shasta__hal__rgu_8h.html">shasta_hal_rgu.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="shasta__hal__scu_8h.html">shasta_hal_scu.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="log__app_8h.html">log_app.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="cmsis__os_8h.html">cmsis_os.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="configurator_8h.html">configurator.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="fw__params_8h.html">fw_params.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="pmbus__drv_8h.html">pmbus_drv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="faults__drv_8h.html">faults_drv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="telemetry__drv_8h.html">telemetry_drv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="regulation__drv_8h.html">regulation_drv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="gpio__drv_8h.html">gpio_drv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="patch__app_8h.html">patch_app.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="mmu__drv_8h.html">mmu_drv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="driver__common_8h.html">driver_common.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="shasta__hal__tstctrl_8h.html">shasta_hal_tstctrl.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="telemetry__api_8h.html">telemetry_api.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="version_8h.html">version.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="wdt__drv_8h.html">wdt_drv.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aaef4649ed6a18e438ac24db2dd2ee48c"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="____main_8c.html#aaef4649ed6a18e438ac24db2dd2ee48c">RESET_RESISTANT_DECLARE</a> (<a class="el" href="structos_exception__t.html">osException_t</a>, sys_last_critical_exception)</td></tr>
<tr class="separator:aaef4649ed6a18e438ac24db2dd2ee48c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd26e2e1300e4082b72975e5c9211c8a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="environment_8h.html#a10b2d890d871e1489bb02b7e70d9bdfb">STATIC</a> void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="____main_8c.html#acd26e2e1300e4082b72975e5c9211c8a">sys_mem_init</a> (void)</td></tr>
<tr class="separator:acd26e2e1300e4082b72975e5c9211c8a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aafe21945300c173fd8576144707a5646"><td class="memItemLeft" align="right" valign="top"><a class="el" href="environment_8h.html#a10b2d890d871e1489bb02b7e70d9bdfb">STATIC</a> void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="____main_8c.html#aafe21945300c173fd8576144707a5646">sys_memset_bss</a> (uint8_t *start, uint32_t size)</td></tr>
<tr class="separator:aafe21945300c173fd8576144707a5646"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1edc4b70e4977b4092d2f2027a09d812"><td class="memItemLeft" align="right" valign="top"><a class="el" href="environment_8h.html#a10b2d890d871e1489bb02b7e70d9bdfb">STATIC</a> void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="____main_8c.html#a1edc4b70e4977b4092d2f2027a09d812">sys_modules_init</a> (void)</td></tr>
<tr class="separator:a1edc4b70e4977b4092d2f2027a09d812"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0960c8571aac1536f7e7e5f2590d1ff9"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main</a> (void)</td></tr>
<tr class="separator:a0960c8571aac1536f7e7e5f2590d1ff9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a840291bc02cba5474a4cb46a9b9566fe"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="____main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a> (void)</td></tr>
<tr class="separator:a840291bc02cba5474a4cb46a9b9566fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Contains the initialisation of all software parts. It is assumed that the hardware part is already initialised when calling functions within this file. The essential part of this file is the definition of an own __main symbol to suppress the linking of tool specific libraries which create a bare metal C environment. This allows full control over the executable image but one has to consider that the RAM initialisation including decompression (if not deactivated) and other desired functionality like floating point support must be re-implemented. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a0960c8571aac1536f7e7e5f2590d1ff9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void __main </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This is the top-level function for initializing the software part of the CPU subsystem (CPUS). It implements the setup of the C runtime (CRT) environment, which is required for each module initialization. Moreover, it configures and starts the RTOS and all modules.<br />
 Steps in the <a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main()</a> function:</p><ul>
<li>Initialize the memory.</li>
<li>If required, implement a full patch and reset the Shasta controller. Otherwise, proceed with the boot sequence.</li>
<li>Initialize the RTOS.</li>
<li>Initialize all modules.</li>
<li>Start the RTOS (which invokes all module threads).</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main()</a> overrides code from RTX_CM_lib.h, namely the routines _main_init() and __rt_entry(). In other words, <a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main()</a> deliberately replaces any CRT code from RTX or the ARM tool chain. This is done in order to have full control over the boot sequence of the FW because one requirement is to be able to control and understand the duration of the boot sequence. </dd></dl>

</div>
</div>
<a class="anchor" id="a840291bc02cba5474a4cb46a9b9566fe"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Dummy function for RTX which always allocates a thread definition for <a class="el" href="____main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a> (see RTX_CM_lib.h). Our threads are contained within each module. There is no actual 'main' thread. </p><dl class="section return"><dt>Returns</dt><dd>a bogus value ... If <a class="el" href="____main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a> does not return anything, the Keil compiler complains. </dd></dl>

</div>
</div>
<a class="anchor" id="aaef4649ed6a18e438ac24db2dd2ee48c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">RESET_RESISTANT_DECLARE </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structos_exception__t.html">osException_t</a>&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">sys_last_critical_exception&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>drivers Last exception with a <a class="el" href="log_8h.html#aaeb722138d31144678ec9a1925b83e2dacda21a4a072f2261f6d4ab596599f8b0">CRITICAL</a> severity level. Only used for <a class="el" href="log_8h.html#aaeb722138d31144678ec9a1925b83e2da0666e7ee289b420b8f016b5269fa8244">EMERGENCY</a> handling. </p>

</div>
</div>
<a class="anchor" id="acd26e2e1300e4082b72975e5c9211c8a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="environment_8h.html#a10b2d890d871e1489bb02b7e70d9bdfb">STATIC</a> void sys_mem_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initializes the memory for the C runtime (CRT) environment (see <a class="el" href="pg_shasta__sys__mod.html#sctShasta_Boot">Boot Procedure</a> for more details).<br />
 Depending on the image type (see <a class="el" href="image__types_8h.html" title="The firmware build process of Shasta is capable of linking an image as ROM image, as RAM image...">image_types.h</a>), different parts of the memory are affected. For all image types, the function</p><ul>
<li>Clears zero-initialized data in RAM (.bss section; remember that RAM has random values after a POR).</li>
<li>Copies non-zero data from its linker load section to the corresponding .data section.</li>
<li>Switches the memory map of Shasta to use a vector table in RAM (not ROM). This allows patching of interrupt service routines.</li>
</ul>
<p>For a <a class="el" href="image__types_8h.html#a2d9f892d4d8e35df0907f155d6006145">ROM_IMAGE</a>, the vector table in ROM is additionally copied to RAM.</p>
<p>As outlined in <a class="el" href="pg_shasta__sys__mod.html#sctShasta_Boot">Boot Procedure</a>, the CRT code needs to</p><ul>
<li>Zero-initialize all C variables that are declared as uninitialized (e.g. "uint16_t my_var;"). The C standard mandates them to be zeroed before <a class="el" href="____main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a> starts to execute. Technically, this is done by means of a call to memset() in which the linker generates the start address and the length of the region that needs to be zeroed.</li>
<li>Initialize all C variables that are initialized to some non-zero value (e.g. "uint16_t my_var = 123;"). For a RAM image, this initialization is simple: the elf file that is loaded into RAM also writes the relevant initial data to the corresponding physical address where the variables resides. For a ROM image, this needs to be done by copying the respective values from a table in ROM to the corresponding locations in RAM. Having the data in ROM is not sufficient because such data is not declared <code>const</code>. </li>
</ul>

</div>
</div>
<a class="anchor" id="aafe21945300c173fd8576144707a5646"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="environment_8h.html#a10b2d890d871e1489bb02b7e70d9bdfb">STATIC</a> void sys_memset_bss </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This routine performs the memset operation on the .bss segment. The standard lib contains a memset function, which performs a single 32-bit write per loop iteration. The performance of such memset strategy is very bad and leads to a long Shasta CPUs boot-up phase.</p>
<dl class="section note"><dt>Note</dt><dd>: memset requires 56 us on Shasta to clear 2900 bytes. </dd></dl>

</div>
</div>
<a class="anchor" id="a1edc4b70e4977b4092d2f2027a09d812"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="environment_8h.html#a10b2d890d871e1489bb02b7e70d9bdfb">STATIC</a> void sys_modules_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Central point to initialize all firmware modules and their corresponding RTOS threads. First, the patch table is checked to see if any module functions need to be patched. Afterwards there are no constraints on which order the modules should be initialized.</p>
<dl class="Exceptions"><dt><b><a class="el" href="_exceptions.html#_Exceptions000028">Exception:</a></b></dt><dd><p class="startdd">OUT_OF_RESOURCE from patch_otp_process, pmbus_init, patch_init, dcdc_config_init, svid_init </p>
<p>ILLEGAL_PARAMETER from dcdc_config_init, patch_otp_process. </p>
<p class="enddd">TIMEOUT from dcdc_config_init, patch_otp_process. </p>
</dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_bdd9a5d540de89e9fe90efdfc6973a4f.html">common</a></li><li class="navelem"><a class="el" href="dir_d52f7f52f412a942de55fb463ecb0248.html">modules</a></li><li class="navelem"><a class="el" href="dir_ea40cf38b2ef84e391e8ff24bd2ce91d.html">startup</a></li><li class="navelem"><a class="el" href="____main_8c.html">__main.c</a></li>
    <li class="footer">Generated on Wed Nov 8 2023 10:16:58 for XDPP1100 Firmware by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
