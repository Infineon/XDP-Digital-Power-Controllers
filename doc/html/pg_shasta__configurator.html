<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>XDPP1100 Firmware: Configurator FW Module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_infineon.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">XDPP1100 Firmware
   </div>
   <div id="projectbrief">The firmware documentation for the XDPP1100 device family.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pg_shasta__configurator.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Configurator FW Module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sctShasta_Configurator_Intro"></a>
Introduction</h1>
<p>The configurator is a module that manages all configuration which are stored/loaded to/from OTP. Following files are available in OTP:</p><ul>
<li>Trim Structure - Trim Register information (address, number of bits)</li>
<li>Trim Data - Trim Data (default register setting, also contains FW default configuration) defined by ATE</li>
<li>Configuration Structure - Configuration registers information (address, number of bits)</li>
<li>Configuration Data - Configuration data which can be changed by the user, also contains FW configuration</li>
<li>PMBus Structure - PMBus command information</li>
<li>PMBus Default - PMBus default data for loop 0 and loop 1</li>
<li>PMBus User - PMBus user data for loop 0 and loop 1</li>
<li>Partial Register - Partial Configuration register data</li>
<li>Partial PMBus - Single PMBus Command Data</li>
</ul>
<p><a class="anchor" id="Image_Configurator"></a></p><div class="image">
<img src="configurator_icon.svg" alt="configurator_icon.svg"/>
</div>
 <ul>
<li>Configurator files are loaded automatically during boot.</li>
<li>Structure files are directly compiled into ROM in order to save OTP space.</li>
<li>Data files can be stored and restored via PMBus commands, see <a class="el" href="pmbus__api_8h.html" title="Top level API for pmbus driver. ">pmbus_api.h</a>.</li>
</ul>
<h1><a class="anchor" id="sctShasta_Configurator_xvalent"></a>
Xvalent File Selector</h1>
<p>Configurator files can be selected via a <code>xvalent</code> pin, its value ranges from 0 to 15. <br />
 There are three categories of xvalent controlled files</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Definition  </th></tr>
<tr>
<td>xv_full </td><td>Configuration Data<br />
 PMBus User </td></tr>
<tr>
<td>xv_partial </td><td>Partial Register Configuration </td></tr>
<tr>
<td>xv_partial_pmbus </td><td>Partial PMBus Configuration </td></tr>
</table>
<p>If there are less files in a given category than the actual xvalent setting proposes, then the actual xvalent setting is modulo divided by the number of available files. Here is an example. Let's assume that the actual xvalent is <code>13</code>. <br />
 The table below depicts which file will be chosen in each categore depending on the number of store files.</p>
<table class="doxtable">
<tr>
<th>Category </th><th align="center">Files stored in OTP </th><th align="center">Selected File Number  </th></tr>
<tr>
<td>xv_full </td><td align="center">3 </td><td align="center">1 </td></tr>
<tr>
<td>xv_partial </td><td align="center">8 </td><td align="center">5 </td></tr>
<tr>
<td>xv_partial_pmbus </td><td align="center">16 </td><td align="center">13 </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><code>xv_full</code> represents <b>two</b> file categories by itself. The number of files is determined by the number <em>Configuration Data</em> files.<ul>
<li>Configuration Data</li>
<li>PMBus User</li>
</ul>
</dd></dl>
<p>Below is an example </p><table class="doxtable">
<tr>
<th>Category </th><th align="center">Files stored in OTP </th><th align="center">Selected File Number  </th></tr>
<tr>
<td>Configuration Data </td><td align="center">9 </td><td align="center">4 </td></tr>
<tr>
<td>PMBus User </td><td align="center">8 </td><td align="center"><b>error</b> </td></tr>
</table>
<p>In the <b>error</b> case <em>PMBUS User</em> is not loaded and the <em>PMBUS Default</em> configuration will be applied instead.</p>
<h1><a class="anchor" id="sctShasta_Configurator_Register_Structure"></a>
Register Structure File</h1>
<p>Register information is based on <a href="../../../../../tools/scripts/otp_file_gen/shasta_revB_register_map.xlsx">Register Map</a></p>
<p>The structural data format describes the structure of how configuration data are stored in the OTP. It is also stored as a data file in OTP besides the data itself. The structural data format is represented by a sequence of uint8_t numbers as described below.</p>
<table class="doxtable">
<tr>
<th>Term </th><th>Definition  </th></tr>
<tr>
<td>Block </td><td>A block describes the registers of a functional block (e.g. analog, pwm) </td></tr>
<tr>
<td>Instance </td><td>A block contains registers and it can be instantiated several times.<br />
The address of instance is reflected by a base address (e.g. 0x7000_0000 <br />
is the base address for the analog module, or 0x7000_0100 is the base<br />
address of vsen0, or 0x7000_0200 is the base address of vsen1,the second <br />
instance of vsen) </td></tr>
<tr>
<td>Register </td><td>Each register has an offset address which adds to the base address of <br />
 the instantiation. (e.g VC_VRAMP1 has the address 0x7000_0404 because it <br />
is in block vcontrol0 which has a base address of 0x7000_0400 and an <br />
offset address of 0x04. </td></tr>
<tr>
<td>Subfield </td><td>Each 32-bit wide register contains subfields which are defined by start position and length </td></tr>
<tr>
<td>start position </td><td>Subfield starting bit position inside the register </td></tr>
<tr>
<td>length </td><td>Subfield length in bits </td></tr>
</table>
<p>See figure below:</p>
<div class="image">
<img src="data_structure_format.png" alt="data_structure_format.png"/>
</div>
 <h1><a class="anchor" id="sctShasta_Configurator_Register_FW_Config"></a>
FW Configuration</h1>
<p>FW configuration data are appended to the end of the trim and config data files.<br />
 The structure is defined in <a class="el" href="fw__params_8h.html#a674d8c960bc9e8e9eb1507124e80a956">FW_TRIM_t</a> for trim and <a class="el" href="fw__params_8h.html#a8a306805262e90d46749cdbe7dcbd05e">FW_CONFIG_t</a> for configuration. <br />
</p>
<p>FW configurations data are defined in <br />
 <a href="https://sec-ishare.infineon.com/sites/shasta/Shared%20Documents/00_Requirements/FWConfig/Shasta_FW_Config.xlsx">https://sec-ishare.infineon.com/sites/shasta/Shared%20Documents/00_Requirements/FWConfig/Shasta_FW_Config.xlsx</a></p>
<p>The tables must start with following entries at the beginning:</p>
<table class="doxtable">
<tr>
<th align="center">Field Name </th><th align="center">size </th><th>Comment  </th></tr>
<tr>
<td align="center">size </td><td align="center">uint16_t </td><td>size of fw configuration in bytes </td></tr>
<tr>
<td align="center">version </td><td align="center">uint16_t </td><td>version number </td></tr>
</table>
<h2><a class="anchor" id="sctShasta_Configurator_Register_FW_Config_Trim"></a>
FW Trim Data</h2>
<p>FW Trim data are located at RAM address <em>0x2005C508</em> for <b>Shasta.A11.ROM.v4_20180124_124011_rom_image</b> and contain following data:</p>
<table class="doxtable">
<tr>
<th align="center">Field Name </th><th align="center">size </th><th align="center">Offset </th><th align="center">Default </th><th>Comment  </th></tr>
<tr>
<td align="center">size </td><td align="center">uint16_t </td><td align="center">0 </td><td align="center">42 </td><td>size of fw configuration in bytes </td></tr>
<tr>
<td align="center">version </td><td align="center">uint16_t </td><td align="center">2 </td><td align="center">2 </td><td>version number </td></tr>
<tr>
<td align="center">bootdesc </td><td align="center">uint32_t </td><td align="center">4 </td><td align="center">3 </td><td>boot descriptor </td></tr>
<tr>
<td align="center">datas </td><td align="center">uint16_t </td><td align="center">8 </td><td align="center">16384 </td><td>size of data partition </td></tr>
<tr>
<td align="center">patchs1 </td><td align="center">uint16_t </td><td align="center">10 </td><td align="center">16384 </td><td>size of patch partition 1 </td></tr>
<tr>
<td align="center">patchs2 </td><td align="center">uint16_t </td><td align="center">12 </td><td align="center">16384 </td><td>size of patch partition 2 </td></tr>
<tr>
<td align="center">patchs3 </td><td align="center">uint16_t </td><td align="center">14 </td><td align="center">16384 </td><td>size of patch partition 3 </td></tr>
<tr>
<td align="center">patchs4 </td><td align="center">uint16_t </td><td align="center">16 </td><td align="center">0 </td><td>size of patch partition 4 </td></tr>
<tr>
<td align="center">patchs5 </td><td align="center">uint16_t </td><td align="center">18 </td><td align="center">0 </td><td>size of patch partition 5 </td></tr>
<tr>
<td align="center">patchs6 </td><td align="center">uint16_t </td><td align="center">20 </td><td align="center">0 </td><td>size of patch partition 6 </td></tr>
<tr>
<td align="center">patchs7 </td><td align="center">uint16_t </td><td align="center">22 </td><td align="center">0 </td><td>size of patch partition 7 </td></tr>
<tr>
<td align="center">patchs8 </td><td align="center">uint16_t </td><td align="center">24 </td><td align="center">0 </td><td>size of patch partition 8 </td></tr>
<tr>
<td align="center">patchs9 </td><td align="center">uint16_t </td><td align="center">26 </td><td align="center">0 </td><td>size of patch partition 9 </td></tr>
<tr>
<td align="center">patchs10 </td><td align="center">uint16_t </td><td align="center">28 </td><td align="center">0 </td><td>size of patch partition 10 </td></tr>
<tr>
<td align="center">patchs11 </td><td align="center">uint16_t </td><td align="center">30 </td><td align="center">0 </td><td>size of patch partition 11 </td></tr>
<tr>
<td align="center">patchs12 </td><td align="center">uint16_t </td><td align="center">32 </td><td align="center">0 </td><td>size of patch partition 12 </td></tr>
<tr>
<td align="center">patchs13 </td><td align="center">uint16_t </td><td align="center">34 </td><td align="center">0 </td><td>size of patch partition 13 </td></tr>
<tr>
<td align="center">patchs14 </td><td align="center">uint16_t </td><td align="center">36 </td><td align="center">0 </td><td>size of patch partition 14 </td></tr>
<tr>
<td align="center">patchs15 </td><td align="center">uint16_t </td><td align="center">38 </td><td align="center">0 </td><td>size of patch partition 15 </td></tr>
<tr>
<td align="center">patchs16 </td><td align="center">uint16_t </td><td align="center">40 </td><td align="center">0 </td><td>size of patch partition 16 </td></tr>
</table>
<h2><a class="anchor" id="sctShasta_Configurator_Register_FW_Config_Config"></a>
FW Config Data</h2>
<p>FW Configuration data are located at RAM address <em>0x2005C500</em> for <b>Shasta.A11.ROM.v4_20180124_124011_rom_image</b> and contain following data:</p>
<table class="doxtable">
<tr>
<th align="center">Field Name </th><th align="center">size </th><th align="center">Offset </th><th align="center">Default </th><th>Comment  </th></tr>
<tr>
<td align="center">size </td><td align="center">uint16_t </td><td align="center">0 </td><td align="center">8 </td><td>size of fw configuration in bytes </td></tr>
<tr>
<td align="center">version </td><td align="center">uint16_t </td><td align="center">2 </td><td align="center">1 </td><td>version number </td></tr>
<tr>
<td align="center">xv_en </td><td align="center">uint8_t </td><td align="center">4 </td><td align="center">1 </td><td>enables xvalent selection<br />
 <code>0</code> = xvalent disabled<br />
 <code>1</code> = xvalent enabled </td></tr>
<tr>
<td align="center">addr_pin_xv </td><td align="center">uint8_t </td><td align="center">5 </td><td align="center">0 </td><td>configurator xvalent pin selection<br />
 <code>0</code> = xaddr1<br />
 <code>1</code> = xaddr2<br />
 </td></tr>
<tr>
<td align="center">addr_pin_pmbus_address_offset </td><td align="center">uint8_t </td><td align="center">6 </td><td align="center">0 </td><td>pmbus address offset xvalent pin selection<br />
 <code>0</code> = xaddr1<br />
 <code>1</code> = xaddr2<br />
 </td></tr>
<tr>
<td align="center">addr_pin_i2c_address_offset </td><td align="center">uint8_t </td><td align="center">7 </td><td align="center">0 </td><td>i2c address offset xvalent pin selection<br />
 <code>0</code> = xaddr1<br />
 <code>1</code> = xaddr2<br />
 </td></tr>
</table>
<h1><a class="anchor" id="sctShasta_Configurator_PMBUS_Structure"></a>
PMBUS Structure file</h1>
<p>PMBUS configuration is based on <br />
 <a href="https://sec-ishare.infineon.com/sites/shasta/Shared%20Documents/00_Requirements/PMBus/Shasta_PMBus.xlsx">https://sec-ishare.infineon.com/sites/shasta/Shared%20Documents/00_Requirements/PMBus/Shasta_PMBus.xlsx</a></p>
<p>The PMBus structure is described as follows:</p>
<ul>
<li>i0 The PMBus number of instances <code></code>(numi = 1)</li>
<li>repeated for the number of commands<ul>
<li>r0 The command (8 Bits, 0 - 255)</li>
<li>r1 is command enabled (1 Bit, 0 - 1)</li>
<li>r2 number of bits (9 Bits, 1 - 256)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="sctShasta_Configurator_partial_register_configurations"></a>
Partial Register Configurations</h1>
<p>In order to save OTP space configuration register data can also be stored partially in otp. Instead of storing the whole register space data can be stored as address/data pairs. <br />
 These partial files are loaded successively at startup into the registers. <br />
</p>
<p>For the file format please see <a class="el" href="pg_shasta_otp_file_system.html#sctShasta_otp_file_system_configuration_file_format">OTP Configuration Files Format</a>.</p>
<h1><a class="anchor" id="sctShasta_Configurator_partial_pmbus_configurations"></a>
Partial PMBus Configurations</h1>
<p>Configurations for single PMBus commands can be stored in partial PMBus configuration. Theses files use a different format as outlined below. <br />
 The header contains a field for the loop and a field for the respective PMBus command.</p>
<table class="doxtable">
<tr>
<th align="center">Field Name </th><th align="center">size </th><th align="center">Comment  </th></tr>
<tr>
<td align="center">cmd </td><td align="center">uint8_t </td><td align="center">file identifier (see <a class="el" href="otp__fs_8h.html#a822d0027045dbf83793fc39bf6b55b23">Otp_File_System_Cmd_Types_t</a>) </td></tr>
<tr>
<td align="center">xvalent </td><td align="center">uint8_t </td><td align="center">identifies the xvalent selector </td></tr>
<tr>
<td align="center">pcmd </td><td align="center">uint8_t </td><td align="center">pmbus command field (0 - 255) </td></tr>
<tr>
<td align="center">lp </td><td align="center">uint8_t </td><td align="center">loop field (0 or 1) </td></tr>
<tr>
<td align="center">len </td><td align="center">uint16_t </td><td align="center">length of the file in bytes </td></tr>
<tr>
<td align="center">len_red </td><td align="center">uint16_t </td><td align="center">redundant length field for safety </td></tr>
<tr>
<td align="center">crc </td><td align="center">uint32_t </td><td align="center">crc for header protection </td></tr>
<tr>
<td align="center">data </td><td align="center"></td><td align="center">arbitrary data </td></tr>
<tr>
<td align="center">crc </td><td align="center">uint32_t </td><td align="center">crc for data protection </td></tr>
</table>
<h1><a class="anchor" id="sctShasta_Configurator_otp_file_generation"></a>
OTP File Generation</h1>
<p>Configuration data defined in the excel files referenced in previous chapters need to be converted into different formats.</p>
<table class="doxtable">
<tr>
<th align="center">File type </th><th>Use Case  </th></tr>
<tr>
<td align="center">*.hex </td><td>RTL simulation </td></tr>
<tr>
<td align="center">*.bin </td><td>Ceedling and ATE processing </td></tr>
<tr>
<td align="center">*.txt </td><td>FPGA verification </td></tr>
</table>
<p>The files are created for each topology, e.g. config_otp_ACF_P5_3P3V_30A files are related to the topology ACF_P5_3P3V_30A.</p>
<p>There are special ceedling files which support the module testing of PMBUS and register configuration content.</p>
<table class="doxtable">
<tr>
<th>File </th><th>Content  </th></tr>
<tr>
<td>ceedling_pmbus_*.c </td><td>PMBUS configuration </td></tr>
<tr>
<td>register_dump_*.c </td><td>Register configuration </td></tr>
</table>
<p>Following files are created for debugging.</p>
<table class="doxtable">
<tr>
<th>File </th><th>Content  </th></tr>
<tr>
<td>log_*.txt </td><td>Useful debug information </td></tr>
<tr>
<td>config_otp_map.txt </td><td>Map of the OTP </td></tr>
</table>
<p>The <b>xvalent</b> files contain a merge of all configurations with each one having a specific xvalent id assigned.</p>
<p>The <b>_mfr</b> configurations require the <code>patch_user_app</code> to be loaded otherwise operation will fail due to a mismatch in the PMBUS configuration.</p>
<p>The figure below depicts the conversion process.</p>
<div class="image">
<img src="shasta_otp_conf_gen.png" alt="shasta_otp_conf_gen.png"/>
<div class="caption">
Conversion Process</div></div>
 <h1><a class="anchor" id="sctShasta_Configurator_Error_Handling"></a>
Error Handling</h1>
<p>As the configuration parameters define somehow the behavior of the firmware and the device, special care should be taken in the following scenarios:</p><ul>
<li>During initialization: if no valid OTP files are found in OTP, FW parameters and registers get default values, PMBus parameters are zero.</li>
<li>On store operation the original files in OTP get invalidated before the new one is stored. Thus it is guaranteed that only one valid file of each type is in OTP.</li>
</ul>
<p>In any case, an invalid crc (for the otp command header or the data itself) will generate an error message. The load or store function in an error event is terminated thus leaving the device with default values in case of a read.</p>
<p>More information can be found in <a class="el" href="configurator_8h.html" title="Public declarations and interface of the application of the configurator FW Module. This module is used to copy/save configuration parameters from/to OTP memory. ">configurator.h</a><br />
 Some useful information regarding file system management can be found in <a class="el" href="otp__fs_8h.html" title="OTP file system layer. ">otp_fs.h</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Nov 8 2023 10:17:00 for XDPP1100 Firmware by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
