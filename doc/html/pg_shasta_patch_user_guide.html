<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>XDPP1100 Firmware: Patch Users Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_infineon.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">XDPP1100 Firmware
   </div>
   <div id="projectbrief">The firmware documentation for the XDPP1100 device family.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pg_shasta_patch_user_guide.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Patch Users Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="pgShasta_patch_user_guide_Introduction"></a>
Introduction</h1>
<p>Patches are used to enhance or replace ROM functions which executable code stored in OTP.</p>
<p>For exemplification the git repository contains several example projects for patching:</p>
<ul>
<li>Partial patch project (<code>projects/patch_user_app</code>) - replacing or adding a function</li>
<li>Full patch project (<code>projects/patch_full_image</code>) - replacing the complete rom_image</li>
</ul>
<h2><a class="anchor" id="pgShasta_patch_user_guide_introduction_partial_patch_Project"></a>
Partial Patch Project</h2>
<p>A partial patch project is always linked against an existing ROM image and optionally against other partial patch images. They are called reference images in the following description. A reference image is identified by the corresponding <code>*.elf</code> image and <code>*.sym</code> symbol file. <br />
Other reference partial patches are applied before the current patch is getting applied.</p>
<p>Partial patches are linked against reference images and are able to call exported functions and use global variables. The firmware supports to solve version dependencies automatically. It only applies patches which are targeted for dedicated firmware versions and upgrades the version information of the overall image (including the added patch). <br />
The generated patch output file prefaces a description header which contains the base and new firmware version information.</p>
<p>The OTP locations where the partial patch is executed depends whether the patch is relocatable or not.</p>
<ul>
<li>Relocatable patches are always compiled and executed from the start of a patch partition. Thus only the first valid patch in a partition gets executed. The patch is relocated to the beginning of the patch via the MMU. In order to replace and existing relocatable patch it must be invalidated before the new patch is stored.</li>
<li>Fixed patches are executed at the address they are stored and therefore need to be compiled for this address. The fixed patches allow to store multiple patches in one partition and they get executed subsequently.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Ensure that all applied patches are linked against each other to avoid memory conflicts. For instance, patch1 and patch2 might show unexpected behavior in case both are linked into overlapping memory regions.</dd></dl>
<p>The patch build environment comes with a RAM locator tool (<code>tools/scripts/elf_ram_allocater.py</code>) which scans the reference image <code>*.elf</code> files to prepare a RAM usage map. It will find a free RAM location where the new patch can store its data. The locator tool generates a <code>patch_link_location.h</code> file during the make process which contains <code>#define</code>'s that describe the patch RAM location. The ARM linker scatter file includes this header file during the linking process.</p>
<p>Each patch project contains a <code>src/partial_patch.cfg</code> configuration file for the RAM locator tool and the version dependencies. It contains the following parameter:</p><ul>
<li>RAM area used by the patch:<br />
<code>tools/scripts/elf_ram_allocater.py</code> searches inside the given range for free RAM memory.</li>
<li>Minimum ram size for the allocation algorithm.</li>
<li>Base Firmware version for which the patch is a replacement (patch is rejected in case of version mismatch)</li>
<li>New Firmware version (version information is updated after the patch got applied).</li>
</ul>
<p>The <code>make simvision_patch</code> build target includes the call of the RAM locator tool.</p>
<p>The following figure shows how the RAM locator tool integrates in the patch linking process.</p>
<div class="image">
<img src="shasta_patch_project_linker_location_generator.png" alt="shasta_patch_project_linker_location_generator.png"/>
</div>
 <h2><a class="anchor" id="pgShasta_patch_user_guide_introduction_full_patch_project"></a>
Full Patch Project</h2>
<p>A full patch is intended to completely replace the startup code by loading a new Interrupt Vector Table and issuing a soft reset. <br />
 After reset the patch code gets executed.</p>
<p>A full patch project can be optionally linked against an existing ROM image (reference image) in order to reuse functions from the ROM.</p>
<h2><a class="anchor" id="pgShasta_patch_user_guide_introduction_tool_chain"></a>
Supported Tool-Chains</h2>
<p>The patching mechanism in Shasta allows to compile patches either with the ARM KEIL compiler or the ARM GNU Compiler tool-chain.<br />
 The tool-chain can be defined by the $TOOLCHAIN variable. $TOOLCHAIN = <b>ARM_GNU</b> sets the ARM GNU tool-chain everything else sets the ARM KEIL tool-chain. <br />
 As the ROM image is compiled with the ARM KEIL compiler tool-chain patches compiled with the ARM GNU tool-chain rely on the compatibility of the embedded-application binary interface (EABI). <br />
 Testing of the two EABIs is not in the scope of the Shasta project, therefore compatibility is assumed. <br />
</p>
<p>Compatibility is violated in the RTX modules by functions using the <code>__value_in_regs</code> attribute.<br />
 These functions return the result by value and not by reference as proposed by EABI. <br />
</p>
<p>Using these functions in a patch compiled with the ARM GNU tool-chain will fail.<br />
 To resolve this issue <a class="el" href="cmsis__os__patch_8h.html" title="patched cmsis API calls which are compatible with GNU and ARM. ">cmsis_os_patch.h</a> was generated. The patch replacement functions can be used either with ARM GNU or ARM KEIL tool-chain.</p>
<dl class="section note"><dt>Note</dt><dd>There is no check for the wrong usage of these functions. <br />
 In order to be safe always use the patch replacement function.</dd></dl>
<table class="doxtable">
<tr>
<th>cmsis_os functions <br />
 using <code>__value_in_regs</code> </th><th>patch replacement function  </th></tr>
<tr>
<td>osWait // if enabled </td><td>osWait_patch </td></tr>
<tr>
<td>osSignalWait </td><td>osSignalWait_patch </td></tr>
<tr>
<td>osMessageGet </td><td>osMessageGet_patch </td></tr>
<tr>
<td>osMailGet </td><td>osMailGet_patch </td></tr>
</table>
<h2><a class="anchor" id="pgShasta_patch_user_guide_introduction_build_targets"></a>
Patch Make Build Target Overview</h2>
<p>The following table lists the make file targets per patch type. This is to make explicit that the make file target for partial patch and full patch is the same.</p>
<table class="doxtable">
<tr>
<th>Patch Type </th><th>Make Target  </th></tr>
<tr>
<td>partial patch </td><td><code>make simvision_patch</code> </td></tr>
<tr>
<td>full patch </td><td><code>make simvivion_patch</code> </td></tr>
</table>
<h1><a class="anchor" id="pgUser_Entry"></a>
Full User Entry Points</h1>
<p>The user has various pointer entry locations into the boot and execution flow of the ROM code. The user patch application can set these pointers to functions in the OTP. This allows flexible boot flow control for a user and a way to fix possible bugs or change driver behavior of ROM code. Note that none of the interrupt handlers are setup as patch table pointers because the NVIC itself has a pointer table to the callback function. To patch a IRQ handle just change the NVIC callback pointer. The image below captures various patch entry locations and the functions the user can call to modify execution flow.</p>
<div class="image">
<img src="user_patch_entry.jpg" alt="user_patch_entry.jpg"/>
</div>
 <p>Regulation state machine callbacks allow the user to call a function on any state + control combination of the state machine. This allows a user to set a function to call in perhaps the TON_RISE state with the ENABLE control.</p>
<p>PMBUS allows for dynamic PMBUS command adds/drops and sizing changes. See <a class="el" href="pg_shasta__p_m_b_u_s.html">PMBUS FW Module</a> for details on auto-generation of PMBUS commands and their handles.</p>
<p>For other function overrides see <a class="el" href="struct_patch___r_o_m___table__t.html">Patch_ROM_Table_t</a> functions.</p>
<h1><a class="anchor" id="pgData_or_FW"></a>
Am I creating data configuration or firmware patches?</h1>
<p>A common question is whether or not a function falls into the category of data/config updates or firmware patches. The table below outlines some common customizations. Please note that all data/config changes can be tested prior to flashing OTP. For example changing the voltage/ PID can be done via PMBUS/I2C commands prior to finalizing the configuration. Only after the debug phase is completed will you need to flash these settings. It is generally a good idea to disable regulation when changing configuration. The rule of thumb is that 10 register or pmbus command changes or less can be handled by partial config images, but for larger changes it is recommended to use a full image type. In general after initial user config data and firmware is flashed most changes are handled via partial data patches.</p>
<table class="doxtable">
<tr>
<th>Customization </th><th>Patch Type </th><th>Image Type  </th></tr>
<tr>
<td>Gain offset correction of ADC at ATE </td><td>data </td><td>trim image </td></tr>
<tr>
<td>Gain offset correction of ADC done by user (more than 10 registers) </td><td>data </td><td>config full image </td></tr>
<tr>
<td>Gain offset correction of ADC done by user (less than 10 registers) </td><td>data </td><td>config partial image </td></tr>
<tr>
<td>Changing PID settings </td><td>data </td><td>config partial image </td></tr>
<tr>
<td>Changing FTR entry and exit thresholds </td><td>data </td><td>config partial image </td></tr>
<tr>
<td>Changing bandwidth of telemetry filters </td><td>data </td><td>config partial image </td></tr>
<tr>
<td>Changing typical input voltage (feed forward) on vrect sensing system </td><td>data </td><td>config partial image </td></tr>
<tr>
<td>Changing pwm configuration </td><td>data </td><td>config partial image and pmbus partial user image (STORE_USER_CODE) </td></tr>
<tr>
<td>Changing target voltage </td><td>data </td><td>pmbus partial user image (STORE_USER_CODE) </td></tr>
<tr>
<td>Changing switching frequency </td><td>data </td><td>pmbus partial user image (STORE_USER_CODE) </td></tr>
<tr>
<td>Changing fault limits </td><td>data </td><td>pmbus partial user image (STORE_USER_CODE) </td></tr>
<tr>
<td>Changing the data of more than 10 PMBUS commands </td><td>data </td><td>pmbus full user image (STORE_USER_ALL) </td></tr>
<tr>
<td>Selecting new transformer and scaling resistors </td><td>data </td><td>pmbus partial user image (STORE_USER_CODE) </td></tr>
<tr>
<td>Changing GPIO that enable pin is mapped to </td><td>data </td><td>config partial image (likely) and pmbus partial user image (STORE_USER_CODE) </td></tr>
<tr>
<td>Changing GPIO that sync pin is mapped to </td><td>data </td><td>config partial image </td></tr>
<tr>
<td>Adding a custom PMBUS command </td><td>fw patch </td><td>user partial patch image </td></tr>
<tr>
<td>Removing PMBUS commands </td><td>fw patch </td><td>user partial patch image </td></tr>
<tr>
<td>Changing size of a PMBUS command </td><td>fw patch </td><td>user partial patch image </td></tr>
<tr>
<td>Adding a custom low speed control loop </td><td>fw patch </td><td>user partial patch image </td></tr>
<tr>
<td>Firmware bug fix for ROM </td><td>fw patch </td><td>user partial patch image </td></tr>
<tr>
<td>Firmware bug fix for user patch in OTP </td><td>fw patch </td><td>user partial patch image in new partition (invalidating partition with bug) </td></tr>
</table>
<p>Some firmware patches that execute at boot time should be run with debugger in open RAM space prior to flashing. Using the linker script and MMU to map RAM to OTP locations is the best approach for this.</p>
<p>In general it is recommended to use the GUI design tools for setup of a new system. The tools simplify the user configuration of the system and provide protections against improper register configurations. The GUI board design tools can be used prior to connecting to an IC.</p>
<p>A script for uploading a patch to OTP is shown in <a class="el" href="pg_shasta_otp_file_system.html#pgsctShasta_otp_file_system_file_store">File Store</a></p>
<h1><a class="anchor" id="pgShasta_patch_user_guide_Setup_a_new_Project"></a>
Setting Up A New Patch Project</h1>
<h2><a class="anchor" id="pgShasta_patch_user_guide_Partial_Patch_Example_Project"></a>
Partial Patch example project</h2>
<p>The following steps describe how to configure a new partial patch firmware project:</p>
<ol type="1">
<li>Go to top git folder (e.g. shasta_fw/)</li>
<li>Execute <b>build_shell</b> </li>
<li>In the <code>cmd</code> box execute <div class="fragment"><div class="line">git_projects <span class="keyword">new</span>-project --ref=reference_project --project=new_project</div>
<div class="line">e.g. git_projects <span class="keyword">new</span>-project --ref=patch_user_app --project=patch_user_test</div>
</div><!-- fragment --> If the <code>reference_project</code> is existing and <code>new_project</code> is new (not existing) the script runs without error. <br />
 You will see now a new project <code>new_project</code> inside the <code>shasta_fw/projects</code> folder.</li>
<li>Update the patch configuration file <code>src/partial_patch.cfg</code><ul>
<li>Set the patch partition address and size. These parameters determines the load and execution region of the patch inside the OTP. They must fit to the partition boundary given by the trim configuration. <br />
 This formula can be used to calculate the parameter <code>startaddress</code>. <br />
 It is basically the sum of all previous partition sizes + the <code>otp_base</code> address. <br />
 The <code>otp_base</code> address for Shasta is 0x10020000. <div class="fragment"><div class="line">&amp;otp_base=0x10020000</div>
<div class="line">&amp;otp_partition=1</div>
<div class="line">; calculate the correct startaddress of the patition</div>
<div class="line">&amp;i=0</div>
<div class="line">&amp;partition_addr=&amp;otp_base</div>
<div class="line">WHILE &amp;i&lt;&amp;otp_partition</div>
<div class="line">(</div>
<div class="line">    &amp;partition_addr=&amp;partition_addr+partition_size[&amp;i])</div>
<div class="line">    &amp;i=&amp;i+1</div>
<div class="line">)</div>
<div class="line">PRINT <span class="stringliteral">&quot;Partition address &amp;partition_addr&quot;</span></div>
</div><!-- fragment --> The table below exemplifies the above formula <table class="doxtable">
<tr>
<th align="center">Partition </th><th align="center">Start Address </th><th align="center">size </th><th align="center">Comment  </th></tr>
<tr>
<td align="center">0 </td><td align="center">0x1002_0000 </td><td align="center">16k </td><td align="center">Trim and configuration </td></tr>
<tr>
<td align="center">1 </td><td align="center">0x1002_4000 </td><td align="center">16k </td><td align="center">Patch1 </td></tr>
<tr>
<td align="center">2 </td><td align="center">0x1002_8000 </td><td align="center">8k </td><td align="center">Patch2 </td></tr>
<tr>
<td align="center">3 </td><td align="center">0x1002_A000 </td><td align="center">4k </td><td align="center">Patch3 </td></tr>
<tr>
<td align="center">4 </td><td align="center">0x1002_B000 </td><td align="center">4k </td><td align="center">Patch4 </td></tr>
</table>
For further details on the file system see <a class="el" href="pg_shasta_otp_file_system.html#sctShasta_otp_file_system_partitions">OTP Partitions</a>. <br />
 The following code snippet shows an example of <code>Patch_OTP</code> settings: <div class="fragment"><div class="line">[Patch_OTP]</div>
<div class="line">startaddress = 0x10024000</div>
<div class="line">size = 0x4000</div>
<div class="line">otp_absolute_address = 1</div>
</div><!-- fragment --> <code>otp_absolute_address</code> determines if the startaddress is an absolute otp start address.<ul>
<li>if <code>absolute_address</code> = 1 the patch must be stored at startaddress and the patch is executed from this address. Ideally this address is the start of a partition or next to an adjacent patch.</li>
<li>if <code>absolute_address</code> = 0 startaddress is the beginning of a partition. The patch can be stored at any address inside the partition and it is re-mapped to the startaddress of the partition.</li>
</ul>
</li>
<li>Set the minimum ram size. This value depends on your estimated value for the RAM the patch is using and might need to be adapted later on in case of linker problems. <br />
The following example shows how to set the patch minimum RAM size of 2 KByte and search over the RAM area from 0x1006300 till 0x20063FFF: <div class="fragment"><div class="line">[Patch_RAM]</div>
<div class="line">startaddress = 0x20063000</div>
<div class="line">endaddress = 0x20063fff</div>
<div class="line">minramsize = 0x400</div>
</div><!-- fragment --></li>
<li>Update the project version dependencies. <br />
 <code>baseversion</code> refers to the version of ROM or the patch which you need to reference. <br />
 The version information is stored in the file<div class="fragment"><div class="line">shasta_fw/ReleaseNotes.txt </div>
</div><!-- fragment --> Below is an example of a <code>shasta_fw/ReleaseNotes.txt</code> file. <div class="fragment"><div class="line">===============================================================================</div>
<div class="line">2018-06-27 08:14:22 , Version: 2</div>
<div class="line">Firmware Details:</div>
<div class="line">       Version UTC Tag:    0x5B33A9CE</div>
<div class="line">       Firmware Project:   <span class="stringliteral">&quot;patch_gan_project&quot;</span></div>
<div class="line">       User:               zojerh (herbert.zojer@infineon.com)</div>
<div class="line">===============================================================================</div>
<div class="line"></div>
<div class="line">- New Feature:</div>
<div class="line">  - vin_on_off scaling implemented</div>
<div class="line">- Restructuring:</div>
<div class="line">  - scaling functions separated into several files.</div>
<div class="line">===============================================================================</div>
<div class="line">2018-06-15 10:29:47 , Version: 1</div>
<div class="line">Firmware Details:</div>
<div class="line">       Version UTC Tag:    0x5B23F78B</div>
<div class="line">       Firmware Project:   <span class="stringliteral">&quot;patch_gan_project&quot;</span></div>
<div class="line">===============================================================================</div>
<div class="line"></div>
<div class="line">- New Feature</div>
<div class="line">  - First version of GAN patch</div>
<div class="line">  - Scaling changed <span class="keywordflow">for</span></div>
<div class="line">    VIN Telemetry</div>
<div class="line">    VIN Faults</div>
<div class="line">    TRANSFORMER</div>
<div class="line">===============================================================================</div>
<div class="line">2018-01-24 12:40:11 , Version: 4</div>
<div class="line">Firmware Details:</div>
<div class="line">       Version UTC Tag:    0x5A68C4FB</div>
<div class="line">       Firmware Project:   <span class="stringliteral">&quot;rom_image&quot;</span></div>
<div class="line">===============================================================================</div>
</div><!-- fragment --> The <code>newversion</code> information is updated by the release process when a new patch is generated.<br />
 The following example shows the patch base and new version information. <br />
 <div class="fragment"><div class="line">[Version]</div>
<div class="line">baseversion = 0x5A68C4FB</div>
<div class="line">newversion = 0x5551EFA5</div>
</div><!-- fragment --> In our example we reference the latest release of the rom_image (2018-01-24 12:40:11 , Version: 4) as our <code>baseversion</code> </li>
<li>Update the reference symbol tables for ROM and partial patch versions which the new patch is referring to. For instance, the new partial patch refers to ROM A11.v24, partial patch A11.v40 and A11.v41 symbols: <div class="fragment"><div class="line">[Elf_and_Symbols]</div>
<div class="line">rom_symbols = ../../versions/Shasta.A11.ROM.v4_20180124_124011_rom_image</div>
<div class="line"><span class="preprocessor">#patch1_symbols = ../../versions/A11.v40_20150310_190000_patch1</span></div>
<div class="line"><span class="preprocessor">#patch2_symbols = ../../versions/A11.v41_20150311_190000_patch2</span></div>
</div><!-- fragment --> In our example we use variable and functions from the latest release of the rom_image (2018-01-24 12:40:11 , Version: 4). <br />
 It also exemplifies how patches can be referenced. If both patches had been uncommented the <code>baseversion</code> would have to be set to the UTC time-stamp of patch2.</li>
</ul>
</li>
<li>Add your source code directories to the <code>Makefile</code> by updating the <code>SOURCE_DIRS</code> and <code>CCOMPILER_DIRS_FILTER</code> variables.</li>
<li>Add your patch specific source code to the <code>src/</code> directory, and add your generic source code to an appropriate sub folder inside the <code>common/modules</code> directory.</li>
<li>Call make to compile your source code and built your patch binary: <div class="fragment"><div class="line">make simvision_patch</div>
</div><!-- fragment --></li>
<li>Finally, as a git user commit and push your new project.</li>
</ol>
<h2><a class="anchor" id="pgShasta_patch_user_guide_Full_Patch_Example_Project"></a>
Full patch example project</h2>
<p>The following steps describe how to configure a new full patch firmware project:</p>
<ol type="1">
<li>Go to top git folder (e.g. shasta_fw/)</li>
<li>Execute <b>build_shell</b> </li>
<li>Execute <div class="fragment"><div class="line">git_projects <span class="keyword">new</span>-project --ref=reference_project --project=new_project</div>
<div class="line">e.g. git_projects <span class="keyword">new</span>-project --ref=path_full_image --project=patch_user_full_image</div>
</div><!-- fragment --> If the <code>reference_project</code> is existing and <code>new_project</code> is new (not existing) the script runs without error. <br />
 You will see now a new project <code>new_project</code> inside the <code>shasta_fw/projects</code> folder.</li>
<li>Continue to follow the steps for <a class="el" href="pg_shasta_patch_user_guide.html#pgShasta_patch_user_guide_Partial_Patch_Example_Project">Partial Patch example project</a></li>
<li>Call make to compile your source code and built your patch binary: <div class="fragment"><div class="line">make simvision_patch</div>
</div><!-- fragment --></li>
<li>Finally, as a git user commit and push your new project.</li>
</ol>
<h1><a class="anchor" id="pgShasta_patch_user_guide_loading_a_patch_to_RAM"></a>
Loading a Patch to RAM</h1>
<p>Sometimes it is beneficial to test a patch before it is uploaded to OTP. <br />
 This can be accomplished by loading a patch to ram and execute it from there. <br />
 For this purpose a Lauterbach script can be used: </p><div class="fragment"><div class="line">; Script <span class="keywordflow">for</span> loading and executing a patch in ram, note we are limited by ram size in what we can execute.</div>
<div class="line">; Filename: execute_patch_from_ram.cmm</div>
<div class="line"></div>
<div class="line">&amp;patch_project=<span class="stringliteral">&quot;patch_gan_project&quot;</span></div>
<div class="line">&amp;patch_bin=<span class="stringliteral">&quot;..\&amp;patch_project\build\simvision\patch.bin&quot;</span></div>
<div class="line">&amp;patch_elf=<span class="stringliteral">&quot;..\&amp;patch_project\build\simvision\patch.elf&quot;</span></div>
<div class="line"></div>
<div class="line">; Reset and restart the system <span class="keyword">this</span> allows to reload a patch cleanly</div>
<div class="line">; Do not forget to restore the configuration via the GUI before running tests.</div>
<div class="line">; RAM and registers will <span class="keyword">get</span> cleared to <span class="keywordflow">default</span> settings.</div>
<div class="line">SYSTEM.RESETTARGET</div>
<div class="line">GO</div>
<div class="line"></div>
<div class="line">wait 1s</div>
<div class="line"></div>
<div class="line">; Stop the system</div>
<div class="line">BREAK</div>
<div class="line"></div>
<div class="line">print <span class="stringliteral">&quot;attempting to load and run patch in ram&quot;</span></div>
<div class="line"></div>
<div class="line">; Load the symbols from <a class="code" href="mmu__drv_8h.html#a569ddee6da7befff387e20e9296846eca7ef442720f7c0dad11c2a3eb97cbb89c">ROM</a> <span class="keywordflow">for</span> execute and remap functions</div>
<div class="line">&amp;rom_elf=<span class="stringliteral">&quot;.\Shasta.A11.ROM.development_v4_20180124_124011\projects\rom_image\build\simvision\simvision.elf&quot;</span></div>
<div class="line"></div>
<div class="line">; Partitions have a size of 0x4000 by <span class="keywordflow">default</span>, but user must modify <span class="keyword">this</span> <span class="keywordflow">if</span> they planned <a class="code" href="mmu__drv_8h.html#a569ddee6da7befff387e20e9296846eca6b5226cf21f5b21ce13a0221c7aeff59">OTP</a> partitioning differently</div>
<div class="line">; Therefore make sure that the partition size is not exceeded</div>
<div class="line">&amp;otp_partition=1</div>
<div class="line">&amp;otp_partition_size=0x4000</div>
<div class="line">&amp;otp_addr=0x10020000+(&amp;otp_partition*&amp;otp_partition_size)</div>
<div class="line"></div>
<div class="line">; load the patch image via bin file ...</div>
<div class="line">; put the correct loading address here</div>
<div class="line">&amp;ram_addr=var.value(<a class="code" href="driver__common_8c.html#a3f258308f3439be08405ecf7d88cdc01">DRIVER_COMMON_STRUCT</a>.<a class="code" href="struct_d_r_i_v_e_r___c_o_m_m_o_n___s_t_r_u_c_t__s.html#af30a74f3629d057edc38c161469aea8c">scratchpad</a>)</div>
<div class="line">PRINT &amp;ram_addr</div>
<div class="line">&amp;end_addr=0x20063FFF</div>
<div class="line">DATA.LOAD.BINARY &amp;patch_bin &amp;ram_addr--&amp;end_addr /nosymbol</div>
<div class="line"></div>
<div class="line">; Read the size of the patch with is at position 4 of the header</div>
<div class="line">&amp;size_addr=D:(&amp;ram_addr+4)</div>
<div class="line">PRINT &amp;size_addr</div>
<div class="line"></div>
<div class="line">&amp;size=DATA.SHORT(&amp;size_addr)</div>
<div class="line">PRINT &amp;size</div>
<div class="line"></div>
<div class="line">V os_running=0</div>
<div class="line"></div>
<div class="line">; Herre we clear all previous symbols</div>
<div class="line">DATA.LOAD.ELF &amp;patch_elf &amp;ram_addr--&amp;end_addr /NoCODE /NoRegister /spath</div>
<div class="line"></div>
<div class="line">; thus we need to load the symbols from rom image again</div>
<div class="line">DATA.LOAD.ELF &amp;rom_elf /NoRegister /NoClear /NoCODE /spath</div>
<div class="line"></div>
<div class="line">;The patch_ram_excecute allows to execute a <span class="keyword">function</span> from ram. The <span class="keyword">function</span> is</div>
<div class="line">;compiled and re-mapped to the the otp partition. Thus it can be later stored directly to <a class="code" href="mmu__drv_8h.html#a569ddee6da7befff387e20e9296846eca6b5226cf21f5b21ce13a0221c7aeff59">OTP</a></div>
<div class="line">;@param partition Pointer to corresponding OTP partition.</div>
<div class="line">;@param cmd_hdr_ptr Pointer to the ram location where the patch is located</div>
<div class="line"></div>
<div class="line">Var.call <a class="code" href="patch__app_8c.html#a812c5b284667979a963fa8a8e4ac1c9b">patch_ram_execute</a>(&amp;otp_partition, &amp;ram_addr)</div>
<div class="line">;B.S <a class="code" href="user__app_8c.html#abf3fceaed72e89c44d179e05bb4d534b">user_drv_init</a></div>
<div class="line">go.return</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">;Restore the CPU context from before our <span class="keyword">function</span> call</div>
<div class="line">Frame.Swap</div>
<div class="line"></div>
<div class="line">;data.dump &amp;otp_addr</div>
<div class="line">;data.dump &amp;ram_addr</div>
<div class="line">;DATA.DUMP 0x10024000--0x10026000</div>
<div class="line"></div>
<div class="line">;PRINT <span class="stringliteral">&quot;Start the patch&quot;</span></div>
<div class="line">GO</div>
</div><!-- fragment --><h1><a class="anchor" id="pgShasta_patch_user_guide_releasing_a_patch"></a>
Releasing a Patch</h1>
<p>There are several reasons for releasing a patch.</p><ol type="1">
<li>Generate a release note</li>
<li>Store the patch in the database such that it can be used and referenced by other patches</li>
<li>Generate a version number which is also stored inside the code and makes this patch unique. <br />
</li>
</ol>
<p>Please follow these steps in Windows</p><ol type="1">
<li>Preferably make a new git clone. This ensure that all files are checked in correctly.</li>
<li>Go to top git folder (e.g. shasta_fw/)</li>
<li>Execute <b>build_shell</b>. Make sure that <code>all</code> variables in <code>build_env.bat</code> are configured correctly.</li>
<li>In the <code>cmd</code> box perform following steps</li>
<li>Change to the directory &lt;project_to_release&gt; (e.g. cd projects)</li>
<li>Perform <code>make clean</code> (To ensure that there is no existing build)</li>
<li>Perform <code>make simvision_patch</code> (Dry run of the compile, it should not create any warning or error)</li>
<li>Perform <code>make clean</code> again (To ensure that there is no existing build)</li>
<li>If the steps above where performed successfully change back to the top of the git folder (e.g. shasta_fw)</li>
<li>Edit <code>RealeaseNotes.txt</code>. After editing the file the top of <code>RealeaseNotes.txt</code> shall look like this. <div class="fragment"><div class="line">- Test release</div>
<div class="line">    For demo purposes only</div>
<div class="line">===============================================================================</div>
<div class="line">2018-06-27 08:14:22 , Version: 2</div>
<div class="line">Firmware Details:</div>
<div class="line">       Version UTC Tag:    0x5B33A9CE</div>
<div class="line">       Firmware Project:   <span class="stringliteral">&quot;patch_gan_project&quot;</span></div>
<div class="line">       User:               zojerh (herbert.zojer@infineon.com)</div>
<div class="line">===============================================================================</div>
<div class="line"></div>
<div class="line">- New Feature:</div>
<div class="line">  - vin_on_off scaling implemented</div>
<div class="line">- Restructuring:</div>
<div class="line">  - scaling functions separated into several files.</div>
<div class="line">===============================================================================</div>
<div class="line">2018-06-15 10:29:47 , Version: 1</div>
<div class="line">Firmware Details:</div>
<div class="line">       Version UTC Tag:    0x5B23F78B</div>
<div class="line">       Firmware Project:   <span class="stringliteral">&quot;patch_gan_project&quot;</span></div>
<div class="line">===============================================================================</div>
</div><!-- fragment --></li>
<li>Save <code>RealeaseNotes.txt</code> and start the release script. <div class="fragment"><div class="line">git_projects development-patch --project=&lt;project_to_release&gt;</div>
<div class="line">e.g. git_projects development-patch --project=patch_gan_project</div>
</div><!-- fragment --></li>
<li>When everything goes correct <code>ReleaseNotes.txt</code> should now be updated to <div class="fragment"><div class="line">===============================================================================</div>
<div class="line">2018-07-28 20:04:00 , Version: 3</div>
<div class="line">Firmware Details:</div>
<div class="line">       Version UTC Tag:    0x5B5D2EA0</div>
<div class="line">       Firmware Project:   <span class="stringliteral">&quot;patch_gan_project&quot;</span></div>
<div class="line">User:</div>
<div class="line">       User:               Herbert Zojer (herbert.zojer@infineon.com)</div>
<div class="line">       WIN Login:          &quot;INFINEON\zojerh&quot;</div>
<div class="line">===============================================================================</div>
<div class="line"></div>
<div class="line">- Test release</div>
<div class="line">    For demo purposes only</div>
<div class="line">===============================================================================</div>
</div><!-- fragment --> It contains a new header with<ul>
<li>Timestamp</li>
<li>Version</li>
<li>UTC Tag</li>
<li>Project information</li>
<li>User information</li>
</ul>
</li>
<li>Finally a git tag is created of the form <code>Shasta.A11.GAN.development_v3_20180728_200400</code>. <br />
 It contains the version number <code>v3</code> and the timestamp <code>20180728_200400</code>.<br />
 Additionally a zip file is created with the same name as the git tag in the shasta_fw folder.<br />
 This zip file contains the whole source code to debug the patch.<br />
 The name of the file is e.g. .A11.GAN.development_v3_20180728_200400.zip. <br />
 For the records it is recommended to store the released zip file in a database.</li>
<li>Last but not least push the release, do not forget the tags. <div class="fragment"><div class="line">git push</div>
<div class="line">git push --tags</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="pgShasta_patch_user_guide_reverting"></a>
Reverting a Patch Release</h2>
<p>If the release went wrong you might want to revert the release.<br />
 Following steps will be needed (as for our example), assuming that the changes are not pushed to the remote repository. </p><div class="fragment"><div class="line">git reset --hard HEAD^</div>
<div class="line">git tag -d Shasta.A11.GAN.development_v3_20180728_200400</div>
</div><!-- fragment --><p> In case the release is already pushed to the remote repository please consult a git expert.</p>
<h1><a class="anchor" id="pgShasta_patch_user_guide_upload_a_patch_to_OTP"></a>
Upload a Patch to OTP</h1>
<p>When a patch is thoroughly tested and released it can be uploaded to the OTP.</p>
<dl class="section note"><dt>Note</dt><dd>Uploading an unreleased patch to OTP normally ends in an unstable situation. It is nearly impossible to track an unreleased binary of a patch back to its source.</dd></dl>
<p>The upload to otp can be done via the GUI or a Lauterbach script. <br />
 See <a class="el" href="pg_shasta_otp_file_system.html#pgsctShasta_otp_file_system_file_store">File Store</a> for the source of the script. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Nov 8 2023 10:17:00 for XDPP1100 Firmware by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
