<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>XDPP1100 Firmware: System FW Module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_infineon.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">XDPP1100 Firmware
   </div>
   <div id="projectbrief">The firmware documentation for the XDPP1100 device family.</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pg_shasta__sys__mod.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">System FW Module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sctShasta_Sys_Intro"></a>
Introduction</h1>
<p>The System Module provides basic services like the boot procedure, power management, inter-thread communication (if not covered by the RTOS itself) and other functionality that is considered "commonly" used throughout the rest of the FW.<br />
 It consists of two modules.</p><ol type="1">
<li>The system module which contains all hardware related header files.</li>
<li>The startup module which contains the startup code and __main.</li>
</ol>
<h1><a class="anchor" id="sctShasta_Boot"></a>
Boot Procedure</h1>
<p>The boot procedure follows the rather standard flow of functionality - it starts with very low-level activities for initialization of the CPUS itself, followed by medium-level activities of the C runtime (CRT) environment which prepares the memory for the last stage, the application-level initializations.</p>
<p>More detailed, the boot procedure is implemented by executing the following functions in the given order:</p><ul>
<li><a class="el" href="system__shasta_8c.html#a93f514700ccf00d08dbdcff7f1224eb2">SystemInit()</a> is doing the low-level configuration and initialization work for the CPUS. It retrieves the so-called boot descriptor from a SCU register and executes whatever the boot descriptor has been set to. Most importantly, in case the device boots a <a class="el" href="image__types_8h.html#a2d9f892d4d8e35df0907f155d6006145">ROM_IMAGE</a>, <a class="el" href="system__shasta_8c.html#a93f514700ccf00d08dbdcff7f1224eb2">SystemInit()</a> checks whether a full patch overrides the ROM content. The boot descriptor is documented in osys_boot_descr_format.h.</li>
<li><a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main()</a> is the core FW initialization function. This involves initialization of any zero/non-zero data sections. Furthermore, <a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main()</a> configures and starts the RTX RTOS. This automatically hands over control to the RTX scheduler. <dl class="section note"><dt>Note</dt><dd>Partial patches are being applied within <a class="el" href="____main_8c.html#a0960c8571aac1536f7e7e5f2590d1ff9">__main()</a> by running the patch module.</dd></dl>
</li>
</ul>
<h1><a class="anchor" id="sctSystem_Shasta_Cold"></a>
Cold Start</h1>
<p>A power on event result in a CPU firmware restart. The overall firmware is started again with all of the following initialization steps:</p><ul>
<li>Clearing and initializing boot resistant RAM content.</li>
<li>Clearing and initializing remaining RAM content.</li>
<li>Start the RTOS</li>
<li>Apply OTP patches</li>
<li>Initialize RTOS tasks</li>
</ul>
<h1><a class="anchor" id="sctSystem_Shasta_Warm"></a>
Warm Start</h1>
<p>A reset event results in a CPU firmware restart. This step is similar to the cold start except the initialization of the boot resistant RAM is omitted.</p>
<h1><a class="anchor" id="sctSystem_Shasta_Restart"></a>
Restart</h1>
<p>The CPUS goes back to "Active" running mode, in case any configured wake-up source triggers an event (e.g. interrupt from external source like SVID or PMBus, timer interrupt). This wake-up trigger is called <b>"Warm Start"</b>.<br />
 The warm start feature has the big advantage that it reduces the power consumption with a short wake up latency. The system is back in normal <b>"Active"</b> mode performance within some clock cycles.</p>
<p>The system supports some warm start features. During system idle condition, mainly when there are no interrupt or task execution, the ARM cortex WFE or WFI instruction is called. This instruction is placed inside the RTOS idle task, because this task is only executed in case no other task or interrupt is called.</p>
<p>The WFE/WFI instruction triggers a CPU <b>"Suspend"-</b> or <b>"Hibernate"-</b> mode, as described in the section <a class="el" href="pg_shasta__sys__mod.html#sctSystem_Shasta_Power_States">Clock &amp; Power States</a>. Both modes clock gate the configured CPUS modules, which reduces the power consumption. From software point of view, it looks like that the system is in a "frozen" state. The CPU stops code execution at the currently given PC and the RAM content stays unchanged. Depending on the hardware configuration, the systick- or DTIMER- timer keep running during <b>"Suspend"</b> mode.</p>
<p>To support system timer features, we only use the <b>"Suspend"</b> mode, where the systick timer stays active.</p>
<h1><a class="anchor" id="sctSystem_Shasta_Power_States"></a>
Clock &amp; Power States</h1>
<p>The CPU subsystem (CPUS) supports different power domain states:</p><ul>
<li><b>"Active"</b>:<ul>
<li>Clock of all enabled CPUS sub modules is running.</li>
<li>No reset is given to enabled CPUS sub modules (Reset Modules Register "RSTMODS": Used modules set to normal operation, no reset).</li>
<li>Software runs with support of RAM and ROM.</li>
</ul>
</li>
<li><b>"Suspend"</b>:<ul>
<li>The CPU, the RAM and some other configured CPUS modules are clock gated.</li>
<li>RAM and CPU contents is kept (not lost).</li>
<li>The systick timer, the watchdog timer and the DTIMER module can be configured to keep the running clock, and are not clock gated.</li>
<li>An CPUS internal or external wake-up source brings the CPUS back to "Active" mode.</li>
<li>Such clock gating configuration can be done on the "CLK_SLEEP_MSK_CNFG" register.</li>
<li>This state is be triggered by the ARM instructions WFE/WFI.</li>
</ul>
</li>
<li><b>"Hibernate"</b>:<ul>
<li>The overall CPUS is clock gated.</li>
<li>No timer support during this state.</li>
<li>RAM and CPU contents is kept (not lost).</li>
<li>An CPUS external wake-up source brings the CPUS back to "Active" mode.</li>
<li>Such clock gating configuration can be done on the "CLK_DEEP_SLEEP_MSK_CNFG" register.</li>
<li>This state is be triggered by the ARM instructions WFE/WFI.</li>
</ul>
</li>
<li><b>"Power Down"</b>:<ul>
<li>CPUS configuration and RAM content is lost</li>
<li>An CPUS external wake-up source brings the CPUS back to "Active" mode.</li>
<li>Firmware triggers this mode by writing to the "SW_PWDN_REQ" register.</li>
<li>An CPUS external hardware signal triggers this mode (HW PWDN Reset). Trigger enabled on the "HW_PWDN_CTRL" register.</li>
</ul>
</li>
</ul>
<p>The following figure illustrates the power saving potential of the different states. As Wake-Up source a CPUS sub module interrupt (e.g. systick timer interrupt) or an external interrupt can be used. </p><div class="image">
<img src="shasta_fw_boot_power.svg" alt="shasta_fw_boot_power.svg"/>
</div>
<p> "Active" consums to most power, and "Power Down" consums the minimal power.</p>
<h2><a class="anchor" id="sctSystem_Shasta_Power_States_Interrupt"></a>
Interrupt Support during "Suspend" and "Hibernate" mode</h2>
<p>The clock of the CPUS PMBus and SVID modules can be clock gated without impacting the interrupt generation logic. This means that these modules could still generate interrupts while the clock is gated.</p>
<p>The WDT kernel requires a running clock, otherwise the watchdog will never expire while the CPUS is not in <b>"Active"</b> mode.</p>
<p>The CPU_clk clock feeds the whole ARM Cortex module, including the systick timer. This clock should stay running and clock gating feature is handled inside the Cortex core. This ensures that the CPU WFE/WFI instruction stops the core execution but keeps the systick timer running.</p>
<p>The DMA_clk needs to stay running in case the DMA should keep running with support to generate interrupts. The cnfg_dma_clk could be clock gated because it is only used for DMA register access.</p>
<p>The GPIO_clk needs to stay running in case we want to detect input signal edges and generate interrupts. For simply level detection, without interrupt support, the GPIO_clk could be gated.</p>
<p>All sleep clock gating configuration can be done on the "CLK_SLEEP_MSK_CNFG" register.</p>
<h1><a class="anchor" id="sctSystem_Shasta_Reset"></a>
Reset Sources</h1>
<p>List of supported reset types and sources:</p><ul>
<li>Reseting the complete CPUS, but keeping the RAM alive is done through the following sources:<ol type="1">
<li><b>"External Reset"</b> through respective pin</li>
<li><b>"WDT"</b> (watchdog), triggered by the Watchdog peripheral</li>
<li><b>"Soft Reset"</b>, triggered by FW</li>
<li><b>"Debugger Reset"</b>, triggered by external debugger through SWD/JTAG command.</li>
</ol>
</li>
<li>Reseting the complete CPUS, putting it into a power-down state, stopping the core and loosing the RAM content:<ol type="1">
<li><b>"HW PWDN"</b> (power-down) signal: Some HW peripheral has decided to power-down the CPUS.</li>
<li><b>"SW PWDN"</b> signal: The FW itself has decided to power-down the CPUS.</li>
</ol>
</li>
<li>Reseting the CPU only:<ol type="1">
<li><b>"CPU Reset"</b>: Reset only core, triggered by FW</li>
</ol>
</li>
</ul>
<p>Please find additional details in Chapter RGU in <a class="el" href="pg_shasta__ref.html#sctShasta_Ref_CPUS_ITS">Internal Target Specification (ITS) of the CPU Subsystem (CPUS)</a>.</p>
<h1><a class="anchor" id="sctShasta_Error_Handling"></a>
Error and Exception Handling</h1>
<p><a class="el" href="pg_lib__struct_exc.html">Structured Exception Handling in C</a></p>
<h1><a class="anchor" id="sctShasta_Thread_Con"></a>
Inter-Thread Communication</h1>
<p>API functions to communicate with threads: </p><table class="doxtable">
<tr>
<th>Thread ID </th><th>API  </th></tr>
<tr>
<td><a class="el" href="pmbus__drv_8h.html#a36eb0f83b4fc043e944a193fe882f8fc">tid_PMBUS_Thread</a> </td><td><a class="el" href="pmbus__api_8h.html#a30bd3c5dd1be80f829c114aa4d238d19">PMBUS_Inter_Thread_Set_Command</a> </td></tr>
<tr>
<td><a class="el" href="regulation__drv_8h.html#a48fb17e39ca3550a2421b680ec2c9458">tid_Regulation_Thread</a> </td><td><a class="el" href="regulation__drv_8h.html#ab164b08b6a3efc5b0f385af047f7b318">REGULATION_INTER_THREAD_SET</a> </td></tr>
<tr>
<td><a class="el" href="telemetry__drv_8h.html#a64ca304eb291cad95c69fb2d4926ec8d">tid_Telemetry_Thread</a> </td><td>None </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Nov 8 2023 10:17:00 for XDPP1100 Firmware by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
